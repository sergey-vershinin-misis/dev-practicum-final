## ML-сервис для прогнозирования популярности размещения банкомата на FastApi

Сервис реализует функциональность для получения предсказания индекса популярности банкомата на основе данных о его 
местоположении и содержит следующие endpoint-ы: 
 - ```/predict-one``` - позволяет выполнить предсказание для одного банкомата;
 - ```/predict-many``` - позволяет выполнить предсказание сразу для нескольких банкоматов;
 - ```/predict-csv``` - позволяет загрузить csv-файл с данными нескольких банкоматов, а в ответ получить другой
csv-файл, в котором добавлены предсказанные индексы популярности;
 - ```/enrich-many``` - позволяет дополнить данные нескольких банкоматов данными сервисов dadata.ru, geotree.ru и 
OpenStreetMap, которые далее используются ML-моделью для прогнозирования;
 - ```/atm-groups``` - возвращает список банковских групп, участвующих в задаче;
 - ```/health``` - проверяет жизнеспособность сервиса (возвращает простой ответ в подтверждение);

[Docker-образ с сервисом](https://hub.docker.com/repository/docker/sevlvershinin/atm-project-api) размещен на 
Docker Hub. Обратите внимание, что запуск образа может занимать несколько минут, в случае, если для сервиса 
включен режим обогащения данными (переменная среды ```DATA_ENRICHMENT_ENABLED``` установлена в TRUE) с использованием 
данных dadata.ru, geotree и OpenStreetMap. 

### Состав файлов репозитория 
Исходный код сервиса расположен в данном репозитории и включает:
- [app/configs](app/configs) - настройки, которые влияют на работу сервиса и могут быть заданы с помощью 
переменных окружения или параметров командной строки;
- [app/data_collection](app/data_collection) - код обогащения исходных данных о банкомате данными сервисов dadata.ru, geotree.ru и 
Open street map;
- [app/predictor](app/predictor) - код класса, реализующего всю логику обработки исходных данных и получения предсказаний 
с помощью ML-модели, а также файлы модели и связанных компонент подготовки данных для модели;
- [app/main.py](app/main.py) - реализацию endpoint-ов сервиса;
- [app/dto_models.py](app/dto_models.py) - код pydantic-моделей;
- [Dockerfile](Dockerfile) - описание докер-образа с ml-сервисом

### Контроль кода с помощью flake8
Для контроля качества кода использована библиотека flake8 со стандартными настройками (за исключением измененной на 120
длины строки - см.настройки в файле [.flake8](.flake8)) 

### Запуск сервиса
#### Запуск в docker-контейнере
Для запуска сервиса можно воспользоваться 
[размещенным на Docker Hub образом](https://hub.docker.com/repository/docker/sevlvershinin/atm-project-bot). Для корректной работы необходимо установить следующие переменные среды:

  - ```REDIS_HOST``` - хост, где размещен Redis
  - ```REDIS_PORT``` -  порт, на котором запущен Redis 
  - ```DATA_ENRICHMENT_ENABLED``` - флаг, определяющий, необходимо ли сервису выполнять обогащение данных
  - ```DADATA_API_KEY``` - api-ключ к сервису Dadata.ru
  - ```DADATA_SECRET_KEY``` - secret-ключ к сервису Dadata.ru
  - ```GEO_TREE_SECRET_KEY``` - secret-ключ к сервису GeoTree.ru

#### Запуск без использования Docker
Запустить сервис можно и вне контейнера. Для этого сохраните локально содержимое текущего каталога с кодом сервиса и выполните следующую команду:
```python
python main.py
  --port=<порт, на котором будет запущен сервис>
  --redis_host=<хост, где размещен redis>
  --redis_port=<порт, на котором запущен redis> 
  --data_enrichment_enabled (или --no-data_enrichment_enabled)
  --dadata_api_key=<api-ключ к сервису Dadata.ru>
  --dadata_secret_key=<secret-ключ к сервису Dadata.ru>
  --geo_tree_secret_key=<secret-ключ к сервису GeoTree.ru>
```   

Состав доступных параметров командной строки можно также получить с использованием команды ```python main.py --help```




